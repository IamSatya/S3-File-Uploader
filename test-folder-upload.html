<!DOCTYPE html>
<html>
<head>
    <title>Folder Upload Test</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 800px; margin: 0 auto; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-left: 3px solid #333; }
        .error { border-left-color: red; background: #fee; }
        .success { border-left-color: green; background: #efe; }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
        input[type="file"] { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>Folder Upload Debug Test</h1>
    <p>This page tests folder upload functionality directly, bypassing React.</p>
    
    <div>
        <input type="file" id="folderInput" webkitdirectory directory multiple />
        <button onclick="testUpload()">Test Upload</button>
    </div>
    
    <div id="logs"></div>

    <script>
        function log(message, type = 'log') {
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            document.getElementById('logs').appendChild(div);
            console.log(message);
        }

        document.getElementById('folderInput').addEventListener('change', function(e) {
            const files = e.target.files;
            log(`File input changed! Files captured: ${files.length}`, 'success');
            
            if (files.length > 0) {
                log(`First file: ${files[0].name}`, 'log');
                log(`webkitRelativePath: ${files[0].webkitRelativePath || 'NOT SET'}`, files[0].webkitRelativePath ? 'success' : 'error');
                
                // Log all files
                for (let i = 0; i < Math.min(5, files.length); i++) {
                    log(`  File ${i}: ${files[i].name} (${files[i].size} bytes) - ${files[i].webkitRelativePath}`, 'log');
                }
                if (files.length > 5) {
                    log(`  ... and ${files.length - 5} more files`, 'log');
                }
            } else {
                log('No files captured!', 'error');
            }
        });

        async function testUpload() {
            const files = document.getElementById('folderInput').files;
            
            if (!files || files.length === 0) {
                log('ERROR: No files selected!', 'error');
                return;
            }

            log(`Starting upload with ${files.length} files...`, 'log');

            const formData = new FormData();
            formData.append('path', '/');

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                formData.append('files', file);
                formData.append('relativePaths[]', file.webkitRelativePath || file.name);
            }

            log('FormData prepared. Entries:', 'log');
            let fileCount = 0;
            let pathCount = 0;
            for (const [key, value] of formData.entries()) {
                if (key === 'files') fileCount++;
                if (key === 'relativePaths[]') pathCount++;
            }
            log(`  files: ${fileCount}`, fileCount > 0 ? 'success' : 'error');
            log(`  relativePaths[]: ${pathCount}`, pathCount > 0 ? 'success' : 'error');

            try {
                log('Sending request to /api/files/upload-folder...', 'log');
                const response = await fetch('/api/files/upload-folder', {
                    method: 'POST',
                    body: formData,
                });

                log(`Response status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`Response body: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');

            } catch (error) {
                log(`ERROR: ${error.message}`, 'error');
                console.error(error);
            }
        }
    </script>
</body>
</html>
